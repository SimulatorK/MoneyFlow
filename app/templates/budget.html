<!DOCTYPE html>
<html lang="en" data-theme="{% if dark_mode %}dark{% else %}light{% endif %}">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} | MoneyFlow</title>
    <link rel="stylesheet" href="/static/app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #f5f6fa;
            --bg-card: #fff;
            --bg-input: #fff;
            --bg-hover: #f0f4fa;
            --bg-header: linear-gradient(135deg, #1a3366 0%, #243869 50%, #2d4a7c 100%);
            --text-primary: #222;
            --text-secondary: #667a9a;
            --text-heading: #1a3366;
            --border-color: #ccd;
            --border-light: #e8eef8;
            --nav-bg: #243869;
            --accent: #3875e8;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1d24;
            --bg-card: #242830;
            --bg-input: #2d323c;
            --bg-hover: #353a47;
            --bg-header: linear-gradient(135deg, #0d1117 0%, #161920 50%, #1f242d 100%);
            --text-primary: #e4e6eb;
            --text-secondary: #98a3b8;
            --text-heading: #b8c5db;
            --border-color: #3d4450;
            --border-light: #353a47;
            --nav-bg: #161920;
            --accent: #4d8ef0;
            --success: #3dd05b;
            --warning: #ffcd39;
            --danger: #f55;
        }
        /* Professional Header - Logo on left, partially overlayed */
        .app-header-brand {
            display: inline-flex;
            align-items: center;
            position: relative;
            padding-left: 30px;
        }
        .app-header-logo {
            position: absolute;
            left: 0;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            opacity: 0.85;
            z-index: 1;
        }
        .app-header-text {
            position: relative;
            z-index: 2;
            padding-left: 35px;
            text-align: left;
            white-space: nowrap;
        }
        .app-title {
            margin: 0;
            font-size: 2.2em;
            font-weight: 800;
            color: #fff;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.5), 0 0 25px rgba(56,117,232,0.3);
            letter-spacing: -0.01em;
            line-height: 1.1;
        }
        .app-subtitle {
            font-size: 0.8em;
            color: rgba(255,255,255,0.9);
            text-shadow: 1px 1px 4px rgba(0,0,0,0.4);
            margin-top: 0.15em;
            margin-left: 2px;
        }
        
        /* Budget Tab Navigation */
        .budget-tabs {
          background: var(--bg-card);
          padding: 0.5em;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .budget-tab-btn {
          padding: 0.8em 1.5em;
          border: 2px solid var(--border-light);
          background: var(--bg-card);
          border-radius: 8px;
          cursor: pointer;
          font-weight: 600;
          color: var(--text-secondary);
          transition: all 0.2s;
          display: flex;
          align-items: center;
          gap: 0.5em;
        }
        .budget-tab-btn:hover {
          border-color: var(--accent);
          color: var(--text-heading);
        }
        .budget-tab-btn.active {
          background: var(--accent);
          color: #fff;
          border-color: var(--accent);
        }
        .budget-tab-btn .badge {
          background: rgba(255,255,255,0.2);
          padding: 0.2em 0.5em;
          border-radius: 10px;
          font-size: 0.8em;
        }
        .budget-tab-content {
          display: none;
        }
        .budget-tab-content.active {
          display: contents;
        }
        
        /* Subscription Card Styles */
        .subscription-card {
          background: var(--bg-card);
          border-radius: 10px;
          padding: 1em;
          margin-bottom: 0.8em;
          border-left: 4px solid var(--accent);
          display: flex;
          justify-content: space-between;
          align-items: center;
          transition: transform 0.2s, box-shadow 0.2s;
        }
        .subscription-card:hover {
          transform: translateX(4px);
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .subscription-card.utility { border-left-color: #ffc107; }
        .subscription-card.service { border-left-color: #28a745; }
        .subscription-info { flex: 1; }
        .subscription-name { font-weight: 600; color: var(--text-heading); }
        .subscription-meta { font-size: 0.85em; color: var(--text-secondary); margin-top: 0.2em; }
        .subscription-amount { font-weight: 700; font-size: 1.1em; }
        .subscription-trend { font-size: 0.8em; margin-top: 0.2em; }
        .subscription-trend.up { color: #dc3545; }
        .subscription-trend.down { color: #28a745; }
        .subscription-trend.neutral { color: var(--text-secondary); }
        
        /* Time Period Filter Buttons */
        .time-period-btn {
            padding: 0.4em 0.7em;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-period-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .time-period-btn.active {
            background: var(--accent);
            color: #fff;
        }
        
        .grid-container-2x2 {
            display: grid;
            /* Creates 2 columns, each taking up an equal fraction of the available space (1fr) */
            grid-template-columns: repeat(2, 1fr);
            /* Creates 2 rows, each taking up an equal fraction of the available space */
            grid-template-rows: repeat(2, 1fr);
            /* Adds a gap (spacing) between the grid cells */
            gap: 10px;
            /* Optional: Set a specific width for the overall grid container */
            width: 300px;
            /* Optional: Set a specific height for the overall grid container */
            height: 300px; 

            /* Optional: Flex container up and down the page */
            flex-direction: column;
            flex-direction: row;
            flex-wrap: wrap;
            
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); }
        
        /* App Header */
        .app-header {
            background: var(--bg-header);
            padding: 1em 2em;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 3px solid var(--accent);
        }
        .header-left { flex: 1; }
        .header-center { flex: 2; text-align: center; }
        .header-right { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 1em; }
        .app-title .icon { margin-right: 0.3em; }
        .app-subtitle { margin: 0.3em 0 0 0; font-size: 0.9em; color: rgba(255,255,255,0.75); }
        .app-version { display: inline-block; background: rgba(255,255,255,0.15); padding: 0.15em 0.6em; border-radius: 12px; font-size: 0.75em; color: rgba(255,255,255,0.9); margin-left: 0.5em; }
        .about-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.9em; padding: 0.5em 1em; border-radius: 6px; background: rgba(255,255,255,0.1); }
        .about-link:hover { background: rgba(255,255,255,0.2); color: #fff; }
        
        /* Profile dropdown */
        .profile-dropdown { position: relative; }
        .profile-btn { display: flex; align-items: center; gap: 0.5em; background: rgba(255,255,255,0.1); border: none; padding: 0.5em 1em; border-radius: 8px; cursor: pointer; color: #fff; font-size: 0.9em; }
        .profile-btn:hover { background: rgba(255,255,255,0.2); }
        .profile-avatar { width: 44px; height: 44px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1em; overflow: hidden; border: 2px solid rgba(255,255,255,0.3); }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: var(--bg-card); border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); min-width: 200px; margin-top: 0.5em; z-index: 1000; overflow: hidden; }
        .dropdown-menu.active { display: block; }
        .dropdown-header { padding: 1em; background: var(--border-light); }
        .dropdown-header .name { font-weight: 600; color: var(--text-heading); }
        .dropdown-header .username { font-size: 0.85em; color: var(--text-secondary); }
        .dropdown-item { display: block; padding: 0.8em 1em; color: var(--text-primary); text-decoration: none; font-size: 0.9em; }
        .dropdown-item:hover { background: var(--border-light); }
        .dropdown-item.danger { color: var(--danger); }
        .dropdown-divider { height: 1px; background: var(--border-light); }
        
        /* Navigation */
        nav { background: var(--nav-bg); padding: 0; display: flex; justify-content: center; }
        .tabs { display: flex; gap: 0; }
        .tab { color: rgba(255,255,255,0.8); text-decoration: none; padding: 1em 1.5em; font-size: 0.95em; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab.active { color: #fff; background: rgba(255,255,255,0.1); border-bottom-color: var(--accent); font-weight: 600; }
        
        .page-content { 
            display: flex; gap: 1.5em; padding: 1.5em; 
            max-width: 1600px; margin: 0 auto; flex-wrap: wrap;
        }
        
        .left-column { flex: 1 1 400px; min-width: 320px; max-width: 450px; }
        .right-column { flex: 2 1 700px; min-width: 400px; }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(60,90,170,0.08);
            padding: 1.5em;
            margin-bottom: 1.5em;
        }
        .card h3 {
            margin: 0 0 1em 0;
            color: var(--text-heading);
            font-size: 1.1em;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 0.5em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Forms */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.8em; margin-bottom: 0.8em; }
        .form-row label { display: flex; flex-direction: column; gap: 0.3em; font-size: 0.9em; color: var(--text-secondary); font-weight: 500; }
        .form-row input, .form-row select { padding: 0.5em; font-size: 0.95em; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-input); color: var(--text-primary); }
        
        .btn-primary { background: var(--accent); color: #fff; border: none; padding: 0.5em 1.2em; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-primary:hover { background: #2a5bb8; }
        .btn-secondary { background: var(--bg-hover); color: var(--text-heading); border: 1px solid var(--border-color); padding: 0.4em 0.9em; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .btn-secondary:hover { background: var(--border-light); }
        .btn-danger { background: #fee; color: var(--danger); border: 1px solid #fcc; padding: 0.3em 0.6em; border-radius: 5px; cursor: pointer; font-size: 0.85em; }
        .btn-danger:hover { background: #fdd; }
        .btn-edit { background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.85em; padding: 0.3em 0.5em; }
        .btn-edit:hover { text-decoration: underline; }
        
        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card); border-radius: 12px; padding: 1.5em 2em;
            max-width: 550px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 85vh; overflow-y: auto;
        }
        .modal h4 { margin: 0 0 1em 0; color: var(--text-heading); }
        .modal-btns { display: flex; gap: 0.8em; justify-content: flex-end; margin-top: 1em; }
        .modal input, .modal select { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color); }
        
        /* Two-column expense layout */
        .expense-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5em;
        }
        @media (max-width: 1100px) {
            .expense-columns { grid-template-columns: 1fr; }
        }
        
        .expense-column {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(60,90,170,0.08);
            padding: 1.2em;
        }
        .expense-column h4 {
            margin: 0 0 0.8em 0;
            color: var(--text-heading);
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 0.5em;
            padding-bottom: 0.5em;
            border-bottom: 2px solid var(--border-light);
        }
        .expense-column.fixed h4 { border-bottom-color: #4caf50; }
        .expense-column.variable h4 { border-bottom-color: #ff9800; }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6em 0.8em;
            background: var(--bg-hover);
            border-radius: 6px;
            margin-bottom: 0.5em;
            border-left: 3px solid var(--accent);
        }
        .expense-item.fixed { border-left-color: #4caf50; }
        .expense-item.variable { border-left-color: #ff9800; }
        
        .expense-item .item-info { flex: 1; }
        .expense-item .item-name { font-weight: 500; color: var(--text-heading); font-size: 0.95em; }
        .expense-item .item-meta { font-size: 0.8em; color: var(--text-secondary); margin-top: 0.2em; }
        .expense-item .item-amount { font-weight: 600; color: var(--text-heading); margin-right: 0.8em; font-size: 0.95em; }
        .expense-item .item-actions { display: flex; gap: 0.3em; }
        
        .type-badge {
            display: inline-block; padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.75em; font-weight: 500;
        }
        .type-need { background: #e3f0e3; color: #2a6b3a; }
        .type-want { background: #fff3cd; color: #856404; }
        .type-savings { background: #d4edda; color: #155724; }
        .type-debt { background: #f8d7da; color: #721c24; }
        [data-theme="dark"] .type-need { background: #1e3a29; color: #7fd98c; }
        [data-theme="dark"] .type-want { background: #3d3520; color: #ffc107; }
        [data-theme="dark"] .type-savings { background: #1a3a27; color: #6ee882; }
        [data-theme="dark"] .type-debt { background: #3a2020; color: #f88; }
        
        /* Summary stats */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 0.8em; margin-bottom: 1em; }
        .summary-box {
            background: var(--bg-hover);
            border-radius: 10px; padding: 1em; text-align: center;
        }
        .summary-box.income { background: linear-gradient(135deg, #d6ffe3, #c8f5d6); }
        .summary-box.expense { background: linear-gradient(135deg, #ffe8e8, #fdd); }
        .summary-box.leftover-positive { background: linear-gradient(135deg, #d6ffe3, #b8f0c8); }
        .summary-box.leftover-negative { background: linear-gradient(135deg, #ffe8e8, #fcc); }
        .summary-box.retirement { background: linear-gradient(135deg, #e3f0ff, #d4e8ff); }
        [data-theme="dark"] .summary-box.income { background: linear-gradient(135deg, #1e3a29, #243a30); }
        [data-theme="dark"] .summary-box.expense { background: linear-gradient(135deg, #3a2525, #3d2020); }
        [data-theme="dark"] .summary-box.leftover-positive { background: linear-gradient(135deg, #1e3a29, #1f3a2a); }
        [data-theme="dark"] .summary-box.leftover-negative { background: linear-gradient(135deg, #3a2525, #3d1f1f); }
        [data-theme="dark"] .summary-box.retirement { background: linear-gradient(135deg, #1e2a3a, #253545); }
        .summary-value { font-size: 1.3em; font-weight: 700; color: var(--text-heading); }
        .summary-value.positive { color: var(--success); }
        .summary-value.negative { color: var(--danger); }
        .summary-label { font-size: 0.75em; color: var(--text-secondary); margin-top: 0.3em; }
        
        /* 50/30/20 Rule */
        .rule-card { background: var(--bg-hover); border: 1px solid var(--border-color); }
        .rule-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .rule-table th, .rule-table td { padding: 0.6em 0.8em; text-align: left; }
        .rule-table th { color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid var(--border-light); font-size: 0.85em; }
        .rule-table td { border-bottom: 1px solid var(--border-light); }
        .rule-table tr:last-child td { border-bottom: none; }
        .rule-table .amount { text-align: right; font-weight: 600; }
        .rule-table .pct { text-align: right; }
        .rule-table .target { text-align: right; color: var(--text-secondary); font-size: 0.9em; }
        .rule-ok { color: var(--success); }
        .rule-warn { color: var(--danger); }
        
        /* Budget vs Actual */
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .comparison-table th, .comparison-table td { padding: 0.5em 0.6em; text-align: left; }
        .comparison-table th { color: var(--text-secondary); font-weight: 600; border-bottom: 2px solid var(--border-light); font-size: 0.85em; }
        .comparison-table td { border-bottom: 1px solid var(--border-light); }
        .comparison-table .amount { text-align: right; font-weight: 500; }
        .comparison-table .over { color: var(--danger); }
        .comparison-table .under { color: var(--success); }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar .fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .progress-bar .fill.under { background: var(--success); }
        .progress-bar .fill.over { background: var(--danger); }
        .progress-bar .fill.near { background: var(--warning); }
        
        /* Unbudgeted expenses */
        .unbudgeted-list {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1em;
            margin-top: 1em;
        }
        [data-theme="dark"] .unbudgeted-list {
            background: #3d3520;
            border-color: #6d5a10;
        }
        .unbudgeted-list h5 {
            margin: 0 0 0.5em 0;
            color: #856404;
            font-size: 0.95em;
        }
        [data-theme="dark"] .unbudgeted-list h5 { color: #ffc107; }
        
        /* Charts */
        .chart-container { position: relative; height: 220px; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5em; }
        @media (max-width: 900px) {
            .chart-row { grid-template-columns: 1fr; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Breakdown bar */
        .breakdown-bar {
            height: 28px; background: var(--border-light); border-radius: 14px; overflow: hidden;
            display: flex; margin: 0.8em 0;
        }
        .breakdown-bar .bar-segment { height: 100%; transition: width 0.3s; min-width: 0; }
        .bar-needs { background: #4caf50; }
        .bar-wants { background: #ff9800; }
        .bar-savings { background: #2196f3; }
        .bar-debt { background: #f44336; }
        .bar-leftover { background: #9e9e9e; }
        
        .breakdown-legend { display: flex; flex-wrap: wrap; gap: 1em; font-size: 0.85em; }
        .legend-item { display: flex; align-items: center; gap: 0.4em; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
        
        /* Rolling averages display */
        .rolling-avgs {
            display: flex;
            gap: 1em;
            font-size: 0.85em;
            color: var(--text-secondary);
            padding: 0.5em;
            background: var(--bg-hover);
            border-radius: 6px;
            margin-top: 0.5em;
        }
        .rolling-avgs span { font-weight: 500; }
        
        /* Totals row */
        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 0.8em;
            margin-top: 0.5em;
            background: var(--border-light);
            border-radius: 6px;
            font-weight: 600;
        }
    </style>
</head>
<body>
  <!-- App Header with Profile Dropdown -->
  <header class="app-header">
    <div class="header-left"></div>
    <div class="header-center">
      <div class="app-header-brand">
        <img src="/static/apple-touch-icon.png" alt="" class="app-header-logo">
        <div class="app-header-text">
          <h1 class="app-title">MoneyFlow</h1>
          <p class="app-subtitle">Your personal finance command center</p>
        </div>
      </div>
    </div>
    <div class="header-right">
      <a href="/about" class="about-link">‚ÑπÔ∏è About</a>
      <div class="profile-dropdown">
        <button class="profile-btn" onclick="toggleProfileDropdown()">
          <div class="profile-avatar">
            {% if profile_picture_b64 %}
            <img src="data:{{ profile_picture_type }};base64,{{ profile_picture_b64 }}" alt="">
            {% else %}
            {{ user.name[0].upper() }}
            {% endif %}
          </div>
          <span>{{ user.name.split()[0] }}</span>
          <span style="font-size:0.7em;">‚ñº</span>
        </button>
        <div class="dropdown-menu" id="profileDropdown">
          <div class="dropdown-header">
            <div class="name">{{ user.name }}</div>
            <div class="username">@{{ user.username }}</div>
          </div>
          <a href="/profile" class="dropdown-item">‚öôÔ∏è Account Settings</a>
          <a href="/profile#data" class="dropdown-item">üìä Manage Data</a>
          <div class="dropdown-divider"></div>
          <a href="/logout" class="dropdown-item danger">üö™ Sign Out</a>
        </div>
      </div>
    </div>
  </header>
  
  <nav>
    <div class="tabs">
      <a href="/home" class="tab">Dashboard</a>
      <a href="/budget" class="tab active">Budget</a>
      <a href="/expenses" class="tab">Expenses</a>
      <a href="/income-taxes" class="tab">Income & Taxes</a>
      <a href="/tools" class="tab">Tools</a>
      <a href="/forum" class="tab">Resources</a>
    </div>
  </nav>
  
  <div class="page-content">
    {% if success %}
    <div class="success-message" style="background: #d4edda; color: #155724; padding: 1em; border-radius: 8px; margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <span>‚úÖ {{ success }}</span>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; cursor: pointer;">√ó</button>
    </div>
    {% endif %}
    {% if error and error != 'duplicate_category' %}
    <div class="error-message" style="background: #f8d7da; color: #721c24; padding: 1em; border-radius: 8px; margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <span>‚ö†Ô∏è {{ error }}</span>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; cursor: pointer;">√ó</button>
    </div>
    {% endif %}
    {% if error == 'duplicate_category' %}
    <div class="error-message" style="background: #f8d7da; color: #721c24; padding: 1em; border-radius: 8px; margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <span>‚ö†Ô∏è This category/subcategory combination already exists in your budget. Each category can only be used once.</span>
      <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; cursor: pointer;">√ó</button>
    </div>
    {% endif %}
    
    <!-- Sub-Tab Navigation for Budget/Subscriptions -->
    <div class="budget-tabs" style="display: flex; gap: 0.5em; margin-bottom: 1.5em; width: 100%; flex-wrap: wrap; justify-content: space-between;">
      <div style="display: flex; gap: 0.5em;">
        <button class="budget-tab-btn {% if active_tab != 'subscriptions' %}active{% endif %}" onclick="showBudgetTab('budget')">
          üìã Budget Manager
        </button>
        <button class="budget-tab-btn {% if active_tab == 'subscriptions' %}active{% endif %}" onclick="showBudgetTab('subscriptions')">
          üîÑ Utilities & Subscriptions
          {% if subscription_stats.count_active > 0 %}
          <span class="badge">${{ "{:,.0f}".format(subscription_stats.total_monthly) }}/mo</span>
          {% endif %}
        </button>
      </div>
      <div style="display: flex; gap: 0.5em; align-items: center;">
        <a href="/budget/csv-export" class="btn-secondary" style="padding: 0.5em 1em; font-size: 0.85em; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3em;">
          üì• Export
        </a>
        <button class="btn-secondary" style="padding: 0.5em 1em; font-size: 0.85em;" onclick="document.getElementById('budgetImportModal').classList.add('active')">
          üì§ Import
        </button>
      </div>
    </div>
    
    <!-- BUDGET TAB CONTENT -->
    <div id="tab-budget" class="budget-tab-content {% if active_tab != 'subscriptions' %}active{% endif %}">
    
    <!-- LEFT COLUMN - Add Expense Form -->
    <div class="left-column">
      
      <!-- Unified Add Budget Item Form -->
      <div class="card">
        <h3>‚ûï Add Budget Item</h3>
        <form method="post" action="" id="unifiedBudgetForm">
          <!-- Expense Type Selector -->
          <div class="form-row">
            <label>Expense Type
              <select name="expense_type" id="expenseTypeSelect" onchange="toggleExpenseTypeForm()" required>
                <option value="fixed">Fixed/Recurring Cost</option>
                <option value="variable">Variable Expense</option>
              </select>
            </label>
          </div>
          
          <!-- Common Fields -->
          <div class="form-row">
            <label>Name
              <input type="text" name="name" id="expenseName" placeholder="e.g., Rent, Groceries, Netflix" required>
            </label>
          </div>
          
          <div class="form-row" style="grid-template-columns: 1fr 1fr;">
            <label>Category Type
              <select name="category_type" id="categoryTypeSelect">
                {% for key, label in category_types %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Frequency <span id="frequencyLabel">(for fixed costs)</span>
              <select name="frequency" id="frequencySelect">
                {% for freq in frequencies %}
                <option value="{{ freq }}" {% if freq == 'monthly' %}selected{% endif %}>{{ freq.replace('-', ' ').title() }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
          
          <!-- Link to Expense Category (Optional for fixed, required for variable) -->
          <div class="form-row" style="grid-template-columns: 1fr 1fr;">
            <label><span id="categoryLinkLabel">Link to Expense Category (Optional)</span>
              <select name="expense_category_id" id="expenseCategorySelect" onchange="loadSubcategoriesForForm(); updateRollingAverages();">
                <option value="">-- None --</option>
                {% for cat in expense_categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Sub-Category
              <select name="expense_subcategory_id" id="expenseSubcategorySelect" onchange="updateRollingAverages();">
                <option value="">All in category</option>
              </select>
            </label>
          </div>
          
          <!-- Amount Source Section -->
          <div style="background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 6px; padding: 1em; margin: 0.8em 0;">
            <label style="font-weight: 600; color: var(--text-heading); display: block; margin-bottom: 0.8em;">Amount Source</label>
            <div style="display: flex; flex-direction: column; gap: 0.8em;">
              <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                <input type="radio" name="amount_mode" value="fixed" id="amountModeFixed" checked onchange="toggleAmountMode()">
                <span><b>Fixed Amount</b> - I know the exact cost</span>
              </label>
              <div class="form-row" id="fixedAmountRow" style="margin-left: 1.5em; grid-template-columns: 1fr;">
                <label>Amount ($)
                  <input type="number" step="0.01" min="0" name="amount" id="amountInput" value="0" placeholder="0.00">
                </label>
              </div>
              
              <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
                <input type="radio" name="amount_mode" value="tracked" id="amountModeTracked" onchange="toggleAmountMode()">
                <span><b>Tracked Average</b> - Use average from expense tracking</span>
              </label>
              <div id="trackedAmountRow" style="margin-left: 1.5em; display: none;">
                <p style="font-size: 0.85em; color: var(--text-secondary); margin: 0 0 0.5em 0;">
                  Select an expense category above to see rolling averages.
                </p>
                <div class="form-row" style="grid-template-columns: 1fr;">
                  <label>Averaging Period
                    <select name="tracking_period_months" id="trackingPeriodSelect">
                      <option value="3">3 Month Rolling Avg</option>
                      <option value="6">6 Month Rolling Avg</option>
                      <option value="12">12 Month Rolling Avg</option>
                    </select>
                  </label>
                </div>
                <div class="rolling-avgs" id="rollingAvgsDisplay" style="display: none;">
                  <div>3mo: <span id="avg3mo">$0</span></div>
                  <div>6mo: <span id="avg6mo">$0</span></div>
                  <div>12mo: <span id="avg12mo">$0</span></div>
                </div>
              </div>
            </div>
          </div>
          
          <input type="hidden" name="use_tracked_average" id="useTrackedInput" value="false">
          <button type="submit" class="btn-primary" style="width: 100%;">Add to Budget</button>
        </form>
        
        <!-- Category Management Link -->
        <div style="margin-top: 1em; padding-top: 1em; border-top: 1px solid var(--border-light); text-align: center;">
          <a href="/expenses#categories" class="btn-secondary" style="text-decoration: none;">
            ‚ûï Manage Categories on Expenses Page
          </a>
        </div>
      </div>
      
      <!-- Income Summary
       <!-- Make a 2x2 grid -->
      <!-- <div class="card">
        <h3>üìä Monthly Income</h3>
        {% if summary.income %}
        <div class="grid-container-2x2">
          <div class="summary-box income">
            <div class="summary-value positive">${{ "{:,.0f}".format(summary.gross_monthly) }}</div>
            <div class="summary-label">Gross</div>
          </div>
          <div class="summary-box expense">
            <div class="summary-value negative">${{ "{:,.0f}".format(summary.income.total_taxes / 12) }}</div>
            <div class="summary-value-percentage">({{ "{:.1f}".format(summary.income.total_taxes / (summary.gross_monthly * 12) * 100) }}%)</div>
            <div class="summary-label">Taxes</div>
          </div>
          <div class="summary-box retirement">
            <div class="summary-value {% if summary.total_retirement_monthly / summary.gross_monthly * 100 >= 20 %}positive{% else %}negative{% endif %}">${{ "{:,.0f}".format(summary.total_retirement_monthly) }}</div>
            <div class="summary-value-percentage">({{ "{:.1f}".format(summary.total_retirement_monthly / summary.gross_monthly * 100) }}%)</div>
            <div class="summary-label">Retirement</div>
          </div>
          <div class="summary-box income">
            <div class="summary-value {% if summary.net_monthly >= 0 %}positive{% else %}negative{% endif %}">${{ "{:,.0f}".format(summary.net_monthly) }}</div>
            <div class="summary-value-percentage">({{ "{:.1f}".format(summary.net_monthly / summary.gross_monthly * 100) }}%)</div>
            <div class="summary-label">Take-Home</div>
          </div>
        </div>
        <div style="text-align: right;">
          <a href="/income-taxes" style="color: var(--accent); font-size: 0.85em;">View details ‚Üí</a>
        </div>
        {% else %}
        <p style="color: var(--text-secondary); text-align: center;">
          No income data. <a href="/income-taxes" style="color: var(--accent);">Set up income ‚Üí</a>
        </p>
        {% endif %}
      </div> -->
      
      <!-- Budget Rule Check -->
      <div class="card rule-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
          <h3 style="margin: 0;">üìê Budget Rule Check</h3>
          <button type="button" class="btn-mini" onclick="toggleBudgetTargetsEdit()" id="editTargetsBtn">‚úèÔ∏è Edit Targets</button>
        </div>
        <p style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 1em;">
          Based on gross monthly income of ${{ "{:,.0f}".format(summary.gross_monthly) }}. 
          <span style="color: var(--accent);">Tip: 50/30/20 is a common guideline - customize to fit your goals!</span>
        </p>
        
        <!-- Display Mode -->
        <div id="budgetRuleDisplay">
          <table class="rule-table">
            <thead>
              <tr>
                <th>Category</th>
                <th class="amount">Amount</th>
                <th class="pct">Actual</th>
                <th class="target">Target</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Needs + Debt*</td>
                <td class="amount">${{ "{:,.0f}".format(summary.total_needs + summary.total_debt) }}</td>
                <td class="pct {% if (summary.needs_pct + summary.debt_pct) <= (user.budget_needs_target or 50) %}rule-ok{% else %}rule-warn{% endif %}">
                  {{ "{:.0f}".format(summary.needs_pct + summary.debt_pct) }}%
                </td>
                <td class="target">‚â§{{ "{:.0f}".format(user.budget_needs_target or 50) }}%</td>
              </tr>
              <tr>
                <td>Debt</td>
                <td class="amount">${{ "{:,.0f}".format(summary.total_debt) }}</td>
                <td class="pct {% if (summary.debt_pct) <= 36 %}rule-ok{% else %}rule-warn{% endif %}">
                  {{ "{:.0f}".format(summary.debt_pct) }}%
                </td>
                <td class="target">‚â§36%</td>
              </tr>
              <tr>
                <td>Wants</td>
                <td class="amount">${{ "{:,.0f}".format(summary.total_wants) }}</td>
                <td class="pct {% if summary.wants_pct <= (user.budget_wants_target or 30) %}rule-ok{% else %}rule-warn{% endif %}">
                  {{ "{:.0f}".format(summary.wants_pct) }}%
                </td>
                <td class="target">‚â§{{ "{:.0f}".format(user.budget_wants_target or 30) }}%</td>
              </tr>
              <tr>
                <td>Savings</td>
                <td class="amount">${{ "{:,.0f}".format(summary.total_savings) }}</td>
                <td class="pct {% if summary.savings_pct >= (user.budget_savings_target or 20) %}rule-ok{% else %}rule-warn{% endif %}">
                  {{ "{:.0f}".format(summary.savings_pct) }}%
                </td>
                <td class="target">‚â•{{ "{:.0f}".format(user.budget_savings_target or 20) }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Edit Mode -->
        <form id="budgetRuleEdit" method="post" action="/budget/update-targets" style="display: none;">
          <table class="rule-table">
            <thead>
              <tr>
                <th>Category</th>
                <th class="target">Your Target (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Needs + Debt</td>
                <td>
                  <input type="number" name="needs_target" value="{{ user.budget_needs_target or 50 }}" 
                         min="0" max="100" step="1" style="width: 60px; text-align: right;"> %
                </td>
              </tr>
              <tr>
                <td>Wants</td>
                <td>
                  <input type="number" name="wants_target" value="{{ user.budget_wants_target or 30 }}" 
                         min="0" max="100" step="1" style="width: 60px; text-align: right;"> %
                </td>
              </tr>
              <tr>
                <td>Savings</td>
                <td>
                  <input type="number" name="savings_target" value="{{ user.budget_savings_target or 20 }}" 
                         min="0" max="100" step="1" style="width: 60px; text-align: right;"> %
                </td>
              </tr>
            </tbody>
          </table>
          <div style="display: flex; gap: 0.5em; margin-top: 1em; justify-content: flex-end;">
            <button type="button" class="btn-secondary" onclick="toggleBudgetTargetsEdit()">Cancel</button>
            <button type="button" class="btn-secondary" onclick="resetToDefaults()">Reset to 50/30/20</button>
            <button type="submit" class="btn-primary">Save Targets</button>
          </div>
        </form>
        
        <p style="font-size: 0.75em; color: var(--text-secondary); margin-top: 0.8em; font-style: italic;">
          *Needs + Debt are combined as debt payments are typically considered essential obligations.
        </p>
      </div>
    </div>
    
    <!-- RIGHT COLUMN - Budget Items & Visualizations -->
    <div class="right-column">
      
      <!-- Budget Overview -->
      <div class="card">
        <h3>
          üí∞ Budget Overview
          <span style="font-size: 0.8em; font-weight: normal; color: var(--text-secondary);">
            (Monthly)
          </span>
        </h3>
        
        <!-- Summary Stats -->
        <div class="summary-grid" style="grid-template-columns: repeat(4, 1fr);">
          <div class="summary-box income">
            <div class="summary-value positive">${{ "{:,.0f}".format(summary.gross_monthly) }}</div>
            <div class="summary-label">Gross</div>
          </div>
          <div class="summary-box expense">
            <div class="summary-value negative">${{ "{:,.0f}".format(summary.income.total_taxes / 12) }}</div>
            <div class="summary-value-percentage">({{ "{:.1f}".format(summary.income.total_taxes / (summary.gross_monthly * 12) * 100) }}%)</div>
            <div class="summary-label">Taxes</div>
          </div>
          <div class="summary-box retirement">
            <div class="summary-value {% if summary.total_retirement_monthly / summary.gross_monthly * 100 >= 20 %}positive{% else %}negative{% endif %}">${{ "{:,.0f}".format(summary.total_retirement_monthly) }}</div>
            <div class="summary-value-percentage">({{ "{:.1f}".format(summary.total_retirement_monthly / summary.gross_monthly * 100) }}%)</div>
            <div class="summary-label">Retirement</div>
          </div>
          <div class="summary-box income">
            <div class="summary-value {% if summary.net_monthly >= 0 %}positive{% else %}negative{% endif %}">${{ "{:,.0f}".format(summary.net_monthly) }}</div>
            <div class="summary-value-percentage">({{ "{:.1f}".format(summary.net_monthly / summary.gross_monthly * 100) }}%)</div>
            <div class="summary-label">Take-Home</div>
          </div>
          <div class="summary-box">
            <div class="summary-value">${{ "{:,.0f}".format(summary.total_needs) }}</div>
            <div class="summary-label">Needs ({{ "{:.0f}".format(summary.needs_pct) }}%)</div>
          </div>
          <div class="summary-box">
            <div class="summary-value">${{ "{:,.0f}".format(summary.total_wants) }}</div>
            <div class="summary-label">Wants ({{ "{:.0f}".format(summary.wants_pct) }}%)</div>
          </div>
          <div class="summary-box">
            <div class="summary-value">${{ "{:,.0f}".format(summary.total_savings) }}</div>
            <div class="summary-label">Savings ({{ "{:.0f}".format(summary.savings_pct) }}%)</div>
          </div>
          <div class="summary-box">
            <div class="summary-value">${{ "{:,.0f}".format(summary.total_debt) }}</div>
            <div class="summary-label">Debt ({{ "{:.0f}".format(summary.debt_pct) }}%)</div>
          </div>
          <div class="summary-card leftover {% if summary.leftover >= 0 %}leftover-positive{% else %}leftover-negative{% endif %}">
            <div class="summary-value {% if summary.leftover >= 0 %}positive{% else %}negative{% endif %}">
              {% if summary.leftover >= 0 %}+{% endif %}${{ "{:,.0f}".format(summary.leftover) }}
            </div>
            <div class="summary-label">Leftover</div>
            {% if summary.unbudgeted_monthly and summary.unbudgeted_monthly > 0 %}
            <div style="font-size: 0.7em; color: var(--text-secondary); margin-top: 0.3em;" title="Leftover includes {{ "{:,.0f}".format(summary.unbudgeted_monthly) }} in unbudgeted expenses">
              <span style="color: #ffc107;">‚ö†Ô∏è</span> Incl. ${{ "{:,.0f}".format(summary.unbudgeted_monthly) }} unbudgeted
            </div>
            {% endif %}
          </div>
        </div>
        
        {% if summary.unbudgeted_monthly and summary.unbudgeted_monthly > 0 %}
        <!-- Unbudgeted Expenses Alert -->
        <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 1em; margin-top: 1em;">
          <div style="display: flex; align-items: flex-start; gap: 0.8em;">
            <span style="font-size: 1.5em;">‚ö†Ô∏è</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text-heading); margin-bottom: 0.3em;">
                Unbudgeted Expenses Detected
              </div>
              <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 0.5em;">
                You have <strong style="color: #e65100;">${{ "{:,.0f}".format(summary.unbudgeted_monthly) }}</strong> in expenses from the last 30 days that aren't covered by your budget categories.
              </div>
              <div style="font-size: 0.85em; color: var(--text-secondary);">
                {% for item in summary.unbudgeted_details[:5] %}
                <span style="display: inline-block; background: var(--bg-hover); padding: 0.2em 0.6em; border-radius: 12px; margin: 0.2em 0.2em 0.2em 0;">
                  {{ item.category_name }}{% if item.subcategory_name %} ‚Ä∫ {{ item.subcategory_name }}{% endif %}: ${{ "{:,.0f}".format(item.amount) }}
                </span>
                {% endfor %}
                {% if summary.unbudgeted_details|length > 5 %}
                <span style="color: var(--text-secondary); font-style: italic;">+{{ summary.unbudgeted_details|length - 5 }} more</span>
                {% endif %}
              </div>
              <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 0.5em; font-style: italic;">
                üí° Tip: Add these categories to your budget to track them properly.
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Breakdown Bar -->
        {% set total_pct = summary.needs_pct + summary.wants_pct + summary.savings_pct + summary.debt_pct %}
        {% set leftover_pct = 100 - total_pct if total_pct < 100 else 0 %}
        <div class="breakdown-bar">
          <div class="bar-segment bar-needs" style="width: {{ summary.needs_pct }}%"></div>
          <div class="bar-segment bar-wants" style="width: {{ summary.wants_pct }}%"></div>
          <div class="bar-segment bar-savings" style="width: {{ summary.savings_pct }}%"></div>
          <div class="bar-segment bar-debt" style="width: {{ summary.debt_pct }}%"></div>
          <div class="bar-segment bar-leftover" style="width: {{ leftover_pct }}%"></div>
        </div>
        <div class="breakdown-legend">
          <div class="legend-item"><span class="legend-dot bar-needs"></span> Needs</div>
          <div class="legend-item"><span class="legend-dot bar-wants"></span> Wants</div>
          <div class="legend-item"><span class="legend-dot bar-savings"></span> Savings</div>
          <div class="legend-item"><span class="legend-dot bar-debt"></span> Debt</div>
          <div class="legend-item"><span class="legend-dot bar-leftover"></span> Leftover</div>
        </div>
      </div>
      
      <!-- Two-Column Expense Layout -->
       <!-- Force two column layout -->
       
       <details open default-open>
        <summary>Fixed and Variable Expenses</summary>
        <div class="expense-columns style="grid-column: span 2;" class="two-column-layout">
          <!-- <details open default-open>
            <summary>Fixed and Variable Expenses</summary> -->
          <!-- Fixed Expenses Column -->
          <div class="expense-column fixed"> 
            <h4>üìå Fixed/Recurring Costs</h4>
            {% set fixed_items = summary.fixed_costs_details %}
            {% if fixed_items %}
              {% for cost in fixed_items %}
              <div class="expense-item fixed">
                <div class="item-info">
                  <div class="item-name">{{ cost.name }}</div>
                  <div class="item-meta">
                    <span class="type-badge type-{{ cost.category_type }}">{{ cost.category_type.title() }}</span>
                    {% if cost.using_tracked %}
                    <span style="color: var(--accent);">{{ cost.tracking_period_months }}mo avg</span>
                    {% else %}
                    <span>${{ "{:,.0f}".format(cost.amount) }}/{{ cost.frequency }}</span>
                    {% endif %}
                  </div>
                </div>
                <div class="item-amount">${{ "{:,.0f}".format(cost.monthly_amount) }}</div>
                <div class="item-actions">
                  <button class="btn-edit" onclick="editFixedCost({{ cost.id }})">‚úèÔ∏è</button>
                  <button class="btn-danger" onclick="deleteFixedCost({{ cost.id }})">√ó</button>
                </div>
              </div>
              {% endfor %}
              <div class="totals-row">
                <span>Total Fixed</span>
                <span>${{ "{:,.0f}".format(summary.total_fixed_monthly) }}/mo</span>
              </div>
            {% else %}
              <p style="color: var(--text-secondary); text-align: center; padding: 1em;">No fixed costs yet.</p>
            {% endif %}
          </div>

          <!-- Variable Expenses Column -->
          <div class="expense-column variable">
            <h4>üìä Variable Expenses</h4>
            {% set variable_items = summary.budget_items %}
            {% if variable_items %}
              {% for item in variable_items %}
              <div class="expense-item variable">
                <div class="item-info">
                  <div class="item-name">{{ item.category_name }}{% if item.subcategory_name %} ‚Ä∫ {{ item.subcategory_name }}{% endif %}</div>
                  <div class="item-meta">
                    <span class="type-badge type-{{ item.category_type }}">{{ item.category_type.title() }}</span>
                    {% if item.use_tracked_average %}
                    <span style="color: var(--accent);">{{ item.tracking_period_months }}mo avg</span>
                    {% else %}
                    <span>Fixed: ${{ "{:,.0f}".format(item.specified_amount) }}</span>
                    {% endif %}
                  </div>
                </div>
                <div class="item-amount">${{ "{:,.0f}".format(item.monthly_amount) }}</div>
                <div class="item-actions">
                  <button class="btn-edit" onclick="editBudgetItem({{ item.id }})">‚úèÔ∏è</button>
                  <button class="btn-danger" onclick="deleteBudgetItem({{ item.id }})">√ó</button>
                </div>
              </div>
              {% endfor %}
              <div class="totals-row">
                <span>Total Variable</span>
                <span>${{ "{:,.0f}".format(summary.total_variable_monthly) }}/mo</span>
              </div>
            {% else %}
              <p style="color: var(--text-secondary); text-align: center; padding: 1em;">No variable expenses linked yet.</p>
            {% endif %}
          </div>
          <!-- </details> -->
        </div>
      </details>
      
      <!-- Actual Spending vs Budget -->
      <div class="card">
        <h3>
          üìà Actual Spending vs Budget
          <select id="lookbackSelect" onchange="changeLookback()" style="font-size: 0.85em; padding: 0.3em 0.5em; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary);">
            <option value="1" {% if lookback_months == 1 %}selected{% endif %}>Last Month</option>
            <option value="3" {% if lookback_months == 3 %}selected{% endif %}>Last 3 Months</option>
            <option value="6" {% if lookback_months == 6 %}selected{% endif %}>Last 6 Months</option>
            <option value="12" {% if lookback_months == 12 %}selected{% endif %}>Last 12 Months</option>
          </select>
        </h3>
        <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 1em;">
          Comparing actual spending to budgeted amounts for variable expenses.
          <em>Fixed expenses are assumed spent as budgeted.</em>
        </p>
        
        {% if budget_vs_actual.comparisons %}
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Category</th>
              <th class="amount">Budgeted</th>
              <th class="amount">Actual</th>
              <th class="amount">Diff</th>
              <th style="width: 100px;">Progress</th>
            </tr>
          </thead>
          <tbody>
            {% for c in budget_vs_actual.comparisons %}
            <tr>
              <td>
                {{ c.name }}
                <span class="type-badge type-{{ c.category_type }}" style="margin-left: 0.3em;">{{ c.category_type.title() }}</span>
              </td>
              <td class="amount">${{ "{:,.0f}".format(c.budgeted) }}</td>
              <td class="amount">${{ "{:,.0f}".format(c.actual) }}</td>
              <td class="amount {% if c.is_over %}over{% else %}under{% endif %}">
                {% if c.is_over %}-{% else %}+{% endif %}${{ "{:,.0f}".format(c.difference|abs) }}
              </td>
              <td>
                <div class="progress-bar">
                  {% set pct = c.percentage if c.percentage <= 100 else 100 %}
                  <div class="fill {% if c.percentage > 100 %}over{% elif c.percentage > 90 %}near{% else %}under{% endif %}" style="width: {{ pct }}%;"></div>
                </div>
                <span style="font-size: 0.75em; color: var(--text-secondary);">{{ "{:.0f}".format(c.percentage) }}%</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p style="color: var(--text-secondary); text-align: center;">No variable expenses to compare yet.</p>
        {% endif %}
        
        {% if budget_vs_actual.unbudgeted %}
        <div class="unbudgeted-list">
          <h5>‚ö†Ô∏è Unbudgeted Spending (${{ "{:,.0f}".format(budget_vs_actual.total_unbudgeted) }})</h5>
          <p style="font-size: 0.85em; margin-bottom: 0.5em; color: #856404;">
            These expense categories are not in your budget:
          </p>
          {% for u in budget_vs_actual.unbudgeted %}
          <div style="display: flex; justify-content: space-between; padding: 0.3em 0; border-bottom: 1px solid rgba(0,0,0,0.1);">
            <span>{{ u.category_name }}</span>
            <span style="font-weight: 600;">${{ "{:,.0f}".format(u.amount) }}</span>
            {% if u.subcategories %}
              {% for s in u.subcategories %}
              <span>{{ s.name }}</span>
              <span style="font-weight: 600;">${{ "{:,.0f}".format(s.amount) }}</span>
              {% endfor %}
            {% endif %}
            
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      
      <!-- Charts -->
      <div class="chart-row">
        <div class="card">
          <h3>Budget Allocation by Category</h3>
          <div class="chart-container">
            <canvas id="allocationChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3>Budget vs Actual Spending</h3>
          <div class="chart-container">
            <canvas id="comparisonChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div><!-- End budget tab content -->
  
  <!-- SUBSCRIPTIONS TAB CONTENT -->
  <div id="tab-subscriptions" class="budget-tab-content {% if active_tab == 'subscriptions' %}active{% endif %}">
    <div class="left-column">
      <!-- Add Subscription Form -->
      <div class="card">
        <h3>‚ûï Add Utility/Subscription</h3>
        <form method="post" action="/budget/subscription/add">
          <div class="form-row">
            <label>Name
              <input type="text" name="name" placeholder="e.g., Electric Bill, Netflix..." required>
            </label>
          </div>
          <div class="form-row" style="grid-template-columns: 1fr 1fr;">
            <label>Type
              <select name="utility_type">
                {% for key, label in utility_types %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>Category
              <select name="category_type">
                <option value="need">Need</option>
                <option value="want">Want</option>
              </select>
            </label>
          </div>
          <div class="form-row" style="grid-template-columns: 1fr 1fr;">
            <label>Initial Amount ($)
              <input type="number" name="initial_amount" step="0.01" min="0" placeholder="Optional">
            </label>
            <label>Date
              <input type="date" name="initial_date" value="{{ today }}">
            </label>
          </div>
          <div class="form-row">
            <label>Notes
              <input type="text" name="notes" placeholder="Optional notes...">
            </label>
          </div>
          <div class="form-row" style="grid-template-columns: 1fr 1fr; margin-top: 0.5em;">
            <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
              <input type="checkbox" name="add_to_budget" value="true" checked style="width: auto; margin: 0;" id="addToBudgetCheck" onchange="toggleTrackingPeriod()">
              <span>Add to Variable Expenses</span>
            </label>
            <label id="trackingPeriodLabel">
              Lookback Period
              <select name="tracking_period_months">
                <option value="3">3 months</option>
                <option value="6" selected>6 months (default)</option>
                <option value="12">12 months</option>
              </select>
            </label>
          </div>
          <button type="submit" class="btn-primary">Add Subscription</button>
        </form>
      </div>
      
      <!-- Quick Add Payment Form -->
      {% if subscriptions %}
      <div class="card">
        <h3>üíµ Record Payment</h3>
        <form method="post" action="/budget/subscription/payment/add">
          <div class="form-row">
            <label>Subscription
              <select name="subscription_id" required>
                {% for sub in subscriptions %}
                <option value="{{ sub.id }}">{{ sub.name }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
          <div class="form-row" style="grid-template-columns: 1fr 1fr;">
            <label>Amount ($)
              <input type="number" name="amount" step="0.01" min="0.01" required placeholder="0.00">
            </label>
            <label>Date
              <input type="date" name="payment_date" value="{{ today }}" required>
            </label>
          </div>
          <div class="form-row">
            <label>Notes
              <input type="text" name="notes" placeholder="Optional...">
            </label>
          </div>
          <button type="submit" class="btn-primary">Record Payment</button>
        </form>
      </div>
      {% endif %}
    </div>
    
    <div class="right-column">
      <!-- Subscription Summary -->
      <div class="card">
        <h3>üìä Subscription Summary</h3>
        <div class="summary-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="summary-box">
            <div class="summary-value">{{ subscription_stats.count_active }}</div>
            <div class="summary-label">Active Items</div>
          </div>
          <div class="summary-box expense">
            <div class="summary-value negative">${{ "{:,.0f}".format(subscription_stats.total_monthly) }}</div>
            <div class="summary-label">Est. Monthly</div>
          </div>
          <div class="summary-box">
            <div class="summary-value">${{ "{:,.0f}".format(subscription_stats.total_monthly * 12) }}</div>
            <div class="summary-label">Est. Annual</div>
          </div>
        </div>
      </div>
      
      <!-- Subscriptions List -->
      <div class="card">
        <h3>üîÑ Your Utilities & Subscriptions</h3>
        {% if subscription_stats.subscriptions %}
          {% for sub in subscription_stats.subscriptions %}
          <div class="subscription-card {{ sub.utility_type }}" onclick="showSubscriptionDetails({{ sub.id }})">
            <div class="subscription-info">
              <div class="subscription-name">
                {% if sub.utility_type == 'utility' %}‚ö°{% elif sub.utility_type == 'service' %}üîß{% else %}üì∫{% endif %}
                {{ sub.name }}
              </div>
              <div class="subscription-meta">
                <span class="type-badge type-{{ sub.category_type }}">{{ sub.category_type.title() }}</span>
                ¬∑ {{ sub.payment_count }} payments
                {% if sub.last_payment %}
                ¬∑ Last: {{ sub.last_payment.date[:10] }}
                {% endif %}
              </div>
            </div>
            <div style="text-align: right;">
              <div class="subscription-amount">${{ "{:,.0f}".format(sub.avg_3m) }}/mo</div>
              <div class="subscription-trend {% if sub.trend_pct > 5 %}up{% elif sub.trend_pct < -5 %}down{% else %}neutral{% endif %}">
                {% if sub.trend_pct > 0 %}‚Üë{% elif sub.trend_pct < 0 %}‚Üì{% else %}‚Üí{% endif %}
                {{ "{:.0f}".format(sub.trend_pct|abs) }}% vs prev 3mo
              </div>
            </div>
            <div class="item-actions" style="margin-left: 1em;">
              <button class="btn-danger" onclick="event.stopPropagation(); deleteSubscription({{ sub.id }})">√ó</button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p style="color: var(--text-secondary); text-align: center; padding: 2em;">
            No subscriptions or utilities tracked yet.<br>
            Add your first one using the form!
          </p>
        {% endif %}
      </div>
      
      <!-- Spending Breakdown Chart -->
      <div class="card">
        <h3>üìä Monthly Breakdown</h3>
        <div class="chart-container">
          <canvas id="subscriptionBreakdownChart"></canvas>
        </div>
        <p style="font-size: 0.8em; color: var(--text-secondary); text-align: center; margin-top: 0.5em;">
          Monthly spending breakdown by subscription/utility.
        </p>
      </div>
      
      <!-- Spending Over Time Line Chart -->
      <div class="card" style="grid-column: span 2;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1em;">
          <h3 style="margin: 0;">üìà Spending Over Time</h3>
          <div style="display: flex; align-items: center; gap: 1em; flex-wrap: wrap;">
            <!-- Time Period Filter -->
            <div class="time-period-filter" style="display: flex; gap: 0.25em; background: var(--bg-primary); border-radius: 6px; padding: 0.25em;">
              <button type="button" class="time-period-btn" data-period="1W" onclick="setTimePeriod('1W')">1W</button>
              <button type="button" class="time-period-btn" data-period="1M" onclick="setTimePeriod('1M')">1M</button>
              <button type="button" class="time-period-btn" data-period="3M" onclick="setTimePeriod('3M')">3M</button>
              <button type="button" class="time-period-btn active" data-period="6M" onclick="setTimePeriod('6M')">6M</button>
              <button type="button" class="time-period-btn" data-period="1Y" onclick="setTimePeriod('1Y')">1Y</button>
              <button type="button" class="time-period-btn" data-period="2Y" onclick="setTimePeriod('2Y')">2Y</button>
            </div>
            <!-- Subscription Filter -->
            <div class="subscription-filter-container" style="position: relative;">
              <button type="button" class="btn-secondary" onclick="toggleSubscriptionFilter()" style="padding: 0.4em 0.8em; font-size: 0.85em;">
                Select Items ‚ñº
              </button>
              <div id="subscriptionFilterDropdown" class="subscription-filter-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5em; min-width: 200px; max-height: 250px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                <div style="padding: 0.3em 0.5em; border-bottom: 1px solid var(--border-light); margin-bottom: 0.3em;">
                  <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer; font-weight: 600;">
                    <input type="checkbox" id="subscriptionSelectAll" onchange="toggleAllSubscriptions(this.checked)" checked>
                    Select All
                  </label>
                </div>
                {% if subscription_stats and subscription_stats.subscriptions %}
                {% for sub in subscription_stats.subscriptions %}
                <div style="padding: 0.3em 0.5em;">
                  <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer; font-size: 0.9em;">
                    <input type="checkbox" class="subscription-filter-cb" data-sub-id="{{ sub.id }}" data-sub-name="{{ sub.name }}" checked onchange="updateSpendingChart()">
                    {% if sub.utility_type == 'utility' %}‚ö°{% elif sub.utility_type == 'service' %}üîß{% else %}üì∫{% endif %}
                    {{ sub.name }}
                  </label>
                </div>
                {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="chart-container" style="height: 300px; margin-top: 1em;">
          <canvas id="subscriptionTrendChart"></canvas>
        </div>
        <p style="font-size: 0.8em; color: var(--text-secondary); text-align: center; margin-top: 0.5em;">
          Track how your utility and subscription costs change month to month, seasonally, and year over year.
          <em>Each line represents a different subscription/utility.</em>
        </p>
      </div>
    </div>
  </div><!-- End subscriptions tab content -->
  
  <!-- Subscription Detail Modal -->
  <div class="modal-overlay" id="subscriptionDetailModal">
    <div class="modal" style="max-width: 600px;">
      <h4 id="subscriptionDetailName">Subscription Details</h4>
      <div id="subscriptionDetailContent">
        <!-- Populated by JavaScript -->
      </div>
      <div class="modal-btns">
        <button type="button" class="btn-secondary" onclick="closeSubscriptionDetailModal()">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Budget Import Modal -->
  <div class="modal-overlay" id="budgetImportModal">
    <div class="modal" style="max-width: 550px;">
      <h4>üì§ Import Budget Data</h4>
      <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 1em;">
        Upload a CSV file to import fixed costs, variable expenses, subscriptions, and payment history.
      </p>
      
      <form method="post" action="/budget/csv-import" enctype="multipart/form-data">
        <div class="form-row">
          <label>CSV File
            <input type="file" name="csv_file" accept=".csv" required style="padding: 0.8em;">
          </label>
        </div>
        
        <div style="background: var(--bg-hover); padding: 1em; border-radius: 8px; margin: 1em 0;">
          <h5 style="margin: 0 0 0.5em 0;">CSV Format</h5>
          <p style="font-size: 0.85em; color: var(--text-secondary); margin: 0;">
            The CSV should have a <code>type</code> column with values:
          </p>
          <ul style="font-size: 0.85em; color: var(--text-secondary); margin: 0.5em 0; padding-left: 1.5em;">
            <li><code>fixed_cost</code> - Fixed/recurring costs</li>
            <li><code>budget_item</code> - Variable expense categories</li>
            <li><code>subscription</code> - Utilities & subscriptions</li>
            <li><code>subscription_payment</code> - Payment records</li>
          </ul>
          <a href="/budget/csv-template" style="font-size: 0.85em;">üìÑ Download template file</a>
        </div>
        
        <div class="modal-btns">
          <button type="button" class="btn-secondary" onclick="document.getElementById('budgetImportModal').classList.remove('active')">Cancel</button>
          <button type="submit" class="btn-primary">Import Data</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Edit Fixed Cost Modal -->
  <div class="modal-overlay" id="editFixedCostModal">
    <div class="modal">
      <h4>Edit Fixed Cost</h4>
      <form id="editFixedCostForm" method="post">
        <div class="form-row">
          <label>Name
            <input type="text" name="name" id="editCostName" required>
          </label>
        </div>
        <div class="form-row" style="grid-template-columns: 1fr 1fr;">
          <label>Type
            <select name="category_type" id="editCostType">
              {% for key, label in category_types %}
              <option value="{{ key }}">{{ label }}</option>
              {% endfor %}
            </select>
          </label>
          <label>Frequency
            <select name="frequency" id="editCostFrequency">
              {% for freq in frequencies %}
              <option value="{{ freq }}">{{ freq.replace('-', ' ').title() }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
        
        <div class="form-row" style="grid-template-columns: 1fr 1fr;">
          <label>Expense Category (Optional)
            <select name="expense_category_id" id="editCostCategory" onchange="loadSubcategoriesForFixedCost('edit'); updateEditCostRollingAverages();">
              <option value="">-- None --</option>
              {% for cat in expense_categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label>Sub-Category
            <select name="expense_subcategory_id" id="editCostSubcategory" onchange="updateEditCostRollingAverages();">
              <option value="">All in category</option>
            </select>
          </label>
        </div>
        
        <div style="background: var(--bg-hover); border-radius: 6px; padding: 1em; margin: 1em 0;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.8em;">Amount Source</label>
          <div style="display: flex; flex-direction: column; gap: 0.8em;">
            <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
              <input type="radio" name="amount_mode" value="fixed" id="editAmountModeFixed" onchange="toggleEditAmountMode()">
              <span><b>Fixed Amount</b></span>
            </label>
            <div class="form-row" id="editFixedAmountRow" style="margin-left: 1.5em;">
              <label>Amount ($)
                <input type="number" step="0.01" min="0" name="amount" id="editCostAmount" value="0">
              </label>
            </div>
            
            <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
              <input type="radio" name="amount_mode" value="tracked" id="editAmountModeTracked" onchange="toggleEditAmountMode()">
              <span><b>Tracked Average</b></span>
            </label>
            <div id="editTrackedAmountRow" style="margin-left: 1.5em; display: none;">
              <p style="font-size: 0.85em; color: var(--text-secondary); margin: 0 0 0.5em 0;">
                Select an expense category above to see rolling averages.
              </p>
              <div class="form-row">
                <label>Period
                  <select name="tracking_period_months" id="editCostTrackingPeriod">
                    <option value="3">3 Month Avg</option>
                    <option value="6">6 Month Avg</option>
                    <option value="12">12 Month Avg</option>
                  </select>
                </label>
              </div>
              <div class="rolling-avgs" id="editCostRollingAvgs" style="margin-top: 0.5em;">
                <div>3mo: <span id="editCostAvg3mo">$0</span></div>
                <div>6mo: <span id="editCostAvg6mo">$0</span></div>
                <div>12mo: <span id="editCostAvg12mo">$0</span></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-btns">
          <button type="button" class="btn-secondary" onclick="closeEditFixedCostModal()">Cancel</button>
          <button type="submit" class="btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Edit Budget Item Modal -->
  <div class="modal-overlay" id="editBudgetItemModal">
    <div class="modal">
      <h4>Edit Variable Expense</h4>
      <form id="editBudgetItemForm" method="post">
        <div class="form-row" style="grid-template-columns: 1fr 1fr;">
          <label>Category
            <input type="text" id="editItemCategoryName" readonly style="background: var(--bg-hover);">
          </label>
          <label>Type
            <select name="category_type" id="editItemCategoryType">
              <option value="need">Need</option>
              <option value="want">Want</option>
            </select>
          </label>
        </div>
        
        <div style="background: var(--bg-hover); border-radius: 6px; padding: 1em; margin: 1em 0;">
          <label style="font-weight: 600; display: block; margin-bottom: 0.8em;">Amount Source</label>
          <div style="display: flex; flex-direction: column; gap: 0.8em;">
            <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
              <input type="radio" name="edit_item_amount_source" value="tracked" id="editItemSourceTracked" onchange="toggleEditItemAmountMode()">
              <span><b>Tracked Average</b></span>
            </label>
            <div id="editItemTrackedRow" style="margin-left: 1.5em;">
              <div class="form-row">
                <label>Period
                  <select name="tracking_period_months" id="editItemTrackingPeriod">
                    <option value="3">3 Month Avg</option>
                    <option value="6">6 Month Avg</option>
                    <option value="12">12 Month Avg</option>
                  </select>
                </label>
              </div>
              <div id="editItemTrackedAmounts" class="rolling-avgs" style="margin-top: 0.5em;"></div>
            </div>
            
            <label style="display: flex; align-items: center; gap: 0.5em; cursor: pointer;">
              <input type="radio" name="edit_item_amount_source" value="fixed" id="editItemSourceFixed" onchange="toggleEditItemAmountMode()">
              <span><b>Fixed Amount</b></span>
            </label>
            <div class="form-row" id="editItemFixedRow" style="margin-left: 1.5em; display: none;">
              <label>Monthly Amount ($)
                <input type="number" step="0.01" min="0" name="specified_amount" id="editItemSpecifiedAmount" value="0">
              </label>
            </div>
          </div>
        </div>
        <input type="hidden" name="use_tracked_average" id="editItemUseTracked" value="true">
        
        <div class="modal-btns">
          <button type="button" class="btn-secondary" onclick="closeEditBudgetItemModal()">Cancel</button>
          <button type="submit" class="btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // ===== FORM HANDLING =====
    
    function toggleExpenseTypeForm() {
      const type = document.getElementById('expenseTypeSelect').value;
      const form = document.getElementById('unifiedBudgetForm');
      const frequencyLabel = document.getElementById('frequencyLabel');
      const categoryLinkLabel = document.getElementById('categoryLinkLabel');
      const frequencySelect = document.getElementById('frequencySelect');
      const categorySelect = document.getElementById('expenseCategorySelect');
      
      if (type === 'fixed') {
        form.action = '/budget/fixed-cost/add';
        frequencyLabel.textContent = '(payment frequency)';
        frequencySelect.style.display = 'block';
        frequencySelect.parentElement.style.display = 'flex';
        categoryLinkLabel.textContent = 'Link to Expense Category (Optional)';
        categorySelect.required = false;
      } else {
        form.action = '/budget/item/add';
        frequencyLabel.textContent = '(not used for variable)';
        frequencySelect.style.display = 'none';
        frequencySelect.parentElement.style.display = 'none';
        categoryLinkLabel.textContent = 'Expense Category (Required)';
        categorySelect.required = true;
        // Default to tracked for variable expenses
        document.getElementById('amountModeTracked').checked = true;
        toggleAmountMode();
      }
    }
    
    function toggleAmountMode() {
      const isFixed = document.getElementById('amountModeFixed').checked;
      document.getElementById('fixedAmountRow').style.display = isFixed ? 'grid' : 'none';
      document.getElementById('trackedAmountRow').style.display = isFixed ? 'none' : 'block';
      document.getElementById('useTrackedInput').value = isFixed ? 'false' : 'true';
    }
    
    function toggleEditAmountMode() {
      const isFixed = document.getElementById('editAmountModeFixed').checked;
      document.getElementById('editFixedAmountRow').style.display = isFixed ? 'grid' : 'none';
      document.getElementById('editTrackedAmountRow').style.display = isFixed ? 'none' : 'block';
    }
    
    function toggleEditItemAmountMode() {
      const isTracked = document.getElementById('editItemSourceTracked').checked;
      document.getElementById('editItemTrackedRow').style.display = isTracked ? 'block' : 'none';
      document.getElementById('editItemFixedRow').style.display = isTracked ? 'none' : 'grid';
      document.getElementById('editItemUseTracked').value = isTracked ? 'true' : 'false';
    }
    
    // Load subcategories for form
    async function loadSubcategoriesForForm() {
      const categoryId = document.getElementById('expenseCategorySelect').value;
      const subcategorySelect = document.getElementById('expenseSubcategorySelect');
      
      subcategorySelect.innerHTML = '<option value="">All in category</option>';
      
      if (!categoryId) return;
      
      try {
        const response = await fetch(`/api/subcategories/${categoryId}`);
        const data = await response.json();
        data.subcategories.forEach(sub => {
          const option = document.createElement('option');
          option.value = sub.id;
          option.textContent = sub.name;
          subcategorySelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading subcategories:', err);
      }
    }
    
    // Update rolling averages display
    async function updateRollingAverages() {
      const categoryId = document.getElementById('expenseCategorySelect').value;
      const subcategoryId = document.getElementById('expenseSubcategorySelect').value;
      const display = document.getElementById('rollingAvgsDisplay');
      
      if (!categoryId) {
        display.style.display = 'none';
        return;
      }
      
      try {
        let url = `/api/budget/rolling-averages?category_id=${categoryId}`;
        if (subcategoryId) url += `&subcategory_id=${subcategoryId}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        document.getElementById('avg3mo').textContent = '$' + data.tracked_3mo.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('avg6mo').textContent = '$' + data.tracked_6mo.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('avg12mo').textContent = '$' + data.tracked_12mo.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        display.style.display = 'flex';
      } catch (err) {
        console.error('Error fetching rolling averages:', err);
        display.style.display = 'none';
      }
    }
    
    // ===== FIXED COST FUNCTIONS =====
    
    async function deleteFixedCost(costId) {
      if (!confirm('Delete this fixed cost?')) return;
      try {
        await fetch(`/budget/fixed-cost/${costId}`, { method: 'DELETE' });
        location.reload();
      } catch (err) {
        console.error('Error:', err);
      }
    }
    
    async function editFixedCost(costId) {
      try {
        const response = await fetch(`/api/fixed-cost/${costId}`);
        const data = await response.json();
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        document.getElementById('editCostName').value = data.name;
        document.getElementById('editCostAmount').value = data.amount;
        document.getElementById('editCostFrequency').value = data.frequency;
        document.getElementById('editCostType').value = data.category_type;
        document.getElementById('editCostCategory').value = data.expense_category_id || '';
        document.getElementById('editCostTrackingPeriod').value = data.tracking_period_months || 3;
        
        if (data.expense_category_id) {
          await loadSubcategoriesForFixedCost('edit');
          if (data.expense_subcategory_id) {
            document.getElementById('editCostSubcategory').value = data.expense_subcategory_id;
          }
          // Fetch and display rolling averages
          await updateEditCostRollingAverages();
        }
        
        const isTracked = data.amount_mode === 'tracked';
        document.getElementById('editAmountModeFixed').checked = !isTracked;
        document.getElementById('editAmountModeTracked').checked = isTracked;
        document.getElementById('editFixedAmountRow').style.display = isTracked ? 'none' : 'grid';
        document.getElementById('editTrackedAmountRow').style.display = isTracked ? 'block' : 'none';
        
        document.getElementById('editFixedCostForm').action = `/budget/fixed-cost/update/${costId}`;
        document.getElementById('editFixedCostModal').classList.add('active');
      } catch (err) {
        console.error('Error loading fixed cost:', err);
        alert('Error loading fixed cost data');
      }
    }
    
    async function updateEditCostRollingAverages() {
      const categoryId = document.getElementById('editCostCategory').value;
      const subcategoryId = document.getElementById('editCostSubcategory').value;
      const display = document.getElementById('editCostRollingAvgs');
      
      if (!categoryId) {
        display.style.display = 'none';
        return;
      }
      
      try {
        let url = `/api/budget/rolling-averages?category_id=${categoryId}`;
        if (subcategoryId) url += `&subcategory_id=${subcategoryId}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        document.getElementById('editCostAvg3mo').textContent = '$' + data.tracked_3mo.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('editCostAvg6mo').textContent = '$' + data.tracked_6mo.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('editCostAvg12mo').textContent = '$' + data.tracked_12mo.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        display.style.display = 'flex';
      } catch (err) {
        console.error('Error fetching rolling averages:', err);
        display.style.display = 'none';
      }
    }
    
    function closeEditFixedCostModal() {
      document.getElementById('editFixedCostModal').classList.remove('active');
    }
    
    async function loadSubcategoriesForFixedCost(formPrefix) {
      const categorySelect = document.getElementById(formPrefix === 'edit' ? 'editCostCategory' : 'expenseCategorySelect');
      const subcategorySelect = document.getElementById(formPrefix === 'edit' ? 'editCostSubcategory' : 'expenseSubcategorySelect');
      
      const categoryId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">All in category</option>';
      
      if (!categoryId) return;
      
      try {
        const response = await fetch(`/api/subcategories/${categoryId}`);
        const data = await response.json();
        data.subcategories.forEach(sub => {
          const option = document.createElement('option');
          option.value = sub.id;
          option.textContent = sub.name;
          subcategorySelect.appendChild(option);
        });
      } catch (err) {
        console.error('Error loading subcategories:', err);
      }
    }
    
    // ===== BUDGET ITEM FUNCTIONS =====
    
    async function deleteBudgetItem(itemId) {
      if (!confirm('Remove this from budget?')) return;
      try {
        await fetch(`/budget/item/${itemId}`, { method: 'DELETE' });
        location.reload();
      } catch (err) {
        console.error('Error:', err);
      }
    }
    
    async function editBudgetItem(itemId) {
      try {
        const response = await fetch(`/api/budget-item/${itemId}`);
        const data = await response.json();
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        // Find category name
        const catSelect = document.getElementById('expenseCategorySelect');
        let catName = 'Unknown';
        for (const opt of catSelect.options) {
          if (opt.value == data.expense_category_id) {
            catName = opt.textContent;
            break;
          }
        }
        
        document.getElementById('editItemCategoryName').value = catName;
        document.getElementById('editItemCategoryType').value = data.category_type;
        document.getElementById('editItemTrackingPeriod').value = data.tracking_period_months;
        document.getElementById('editItemSpecifiedAmount').value = data.specified_amount;
        
        // Show tracked amounts
        const trackedAmountsDiv = document.getElementById('editItemTrackedAmounts');
        trackedAmountsDiv.innerHTML = `
          <div>3mo: <span>$${data.tracked_3mo.toLocaleString(undefined, {minimumFractionDigits: 0})}</span></div>
          <div>6mo: <span>$${data.tracked_6mo.toLocaleString(undefined, {minimumFractionDigits: 0})}</span></div>
          <div>12mo: <span>$${data.tracked_12mo.toLocaleString(undefined, {minimumFractionDigits: 0})}</span></div>
        `;
        
        const isTracked = data.use_tracked_average;
        document.getElementById('editItemSourceTracked').checked = isTracked;
        document.getElementById('editItemSourceFixed').checked = !isTracked;
        document.getElementById('editItemTrackedRow').style.display = isTracked ? 'block' : 'none';
        document.getElementById('editItemFixedRow').style.display = isTracked ? 'none' : 'grid';
        document.getElementById('editItemUseTracked').value = isTracked ? 'true' : 'false';
        
        document.getElementById('editBudgetItemForm').action = `/budget/item/update/${itemId}`;
        document.getElementById('editBudgetItemModal').classList.add('active');
      } catch (err) {
        console.error('Error loading budget item:', err);
        alert('Error loading budget item data');
      }
    }
    
    function closeEditBudgetItemModal() {
      document.getElementById('editBudgetItemModal').classList.remove('active');
    }
    
    // ===== LOOKBACK & UI =====
    
    function changeLookback() {
      const lookback = document.getElementById('lookbackSelect').value;
      window.location.href = '/budget?lookback=' + lookback;
    }
    
    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
    
    // Profile dropdown toggle
    function toggleProfileDropdown() {
      document.getElementById('profileDropdown').classList.toggle('active');
    }
    document.addEventListener('click', function(e) {
      const dropdown = document.querySelector('.profile-dropdown');
      if (dropdown && !dropdown.contains(e.target)) {
        document.getElementById('profileDropdown').classList.remove('active');
      }
    });
    
    // Initialize form
    toggleExpenseTypeForm();
    
    // ===== CHARTS =====
    
    // Allocation Chart
    const allocationCtx = document.getElementById('allocationChart');
    if (allocationCtx) {
      new Chart(allocationCtx, {
        type: 'doughnut',
        data: {
          labels: ['Needs', 'Wants', 'Savings', 'Debt', 'Leftover'],
          datasets: [{
            data: [
              {{ summary.total_needs }},
              {{ summary.total_wants }},
              {{ summary.total_savings }},
              {{ summary.total_debt }},
              {{ summary.leftover if summary.leftover > 0 else 0 }}
            ],
            backgroundColor: ['#4caf50', '#ff9800', '#2196f3', '#f44336', '#9e9e9e']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                  return `$${value.toLocaleString()} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Comparison Chart - Budget vs Actual
    const comparisonCtx = document.getElementById('comparisonChart');
    if (comparisonCtx) {
      const comparisons = {{ budget_vs_actual.comparisons | tojson if budget_vs_actual else '[]' }};
      
      if (comparisons && comparisons.length > 0) {
        const labels = comparisons.slice(0, 8).map(c => c.name.length > 15 ? c.name.substring(0, 15) + '...' : c.name);
        const budgetedData = comparisons.slice(0, 8).map(c => c.budgeted);
        const actualData = comparisons.slice(0, 8).map(c => c.actual);
        
        new Chart(comparisonCtx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Budgeted',
                data: budgetedData,
                backgroundColor: '#3875e8',
                borderRadius: 4
              },
              {
                label: 'Actual',
                data: actualData,
                backgroundColor: actualData.map((val, i) => val > budgetedData[i] ? '#f44336' : '#4caf50'),
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { position: 'top', labels: { boxWidth: 12 } },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: $${context.parsed.x.toLocaleString()}`;
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { callback: v => '$' + v.toLocaleString() }
              }
            }
          }
        });
      } else {
        new Chart(comparisonCtx, {
          type: 'bar',
          data: { labels: ['No Data'], datasets: [{ data: [0] }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'Add variable expenses to see comparison', font: { size: 12 }, color: '#889ab0' }
            }
          }
        });
      }
    }
    
    // ===== BUDGET TARGETS FUNCTIONS =====
    function toggleBudgetTargetsEdit() {
      const displayDiv = document.getElementById('budgetRuleDisplay');
      const editForm = document.getElementById('budgetRuleEdit');
      const editBtn = document.getElementById('editTargetsBtn');
      
      if (displayDiv.style.display !== 'none') {
        displayDiv.style.display = 'none';
        editForm.style.display = 'block';
        editBtn.textContent = '‚ùå Cancel';
      } else {
        displayDiv.style.display = 'block';
        editForm.style.display = 'none';
        editBtn.textContent = '‚úèÔ∏è Edit Targets';
      }
    }
    
    function resetToDefaults() {
      document.querySelector('input[name="needs_target"]').value = 50;
      document.querySelector('input[name="wants_target"]').value = 30;
      document.querySelector('input[name="savings_target"]').value = 20;
    }
    
    // ===== SUBSCRIPTION FORM HELPERS =====
    function toggleTrackingPeriod() {
      const checkbox = document.getElementById('addToBudgetCheck');
      const label = document.getElementById('trackingPeriodLabel');
      if (label) {
        label.style.display = checkbox.checked ? 'block' : 'none';
      }
    }
    
    // ===== TAB SWITCHING =====
    function showBudgetTab(tabName) {
      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('tab', tabName);
      window.history.pushState({}, '', url);
      
      // Update tab buttons
      document.querySelectorAll('.budget-tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.budget-tab-btn').classList.add('active');
      
      // Update content
      document.querySelectorAll('.budget-tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
    }
    
    // ===== SUBSCRIPTION FUNCTIONS =====
    async function deleteSubscription(subId) {
      if (!confirm('Delete this subscription and all its payment history?')) return;
      try {
        await fetch(`/budget/subscription/${subId}`, { method: 'DELETE' });
        location.reload();
      } catch (err) {
        console.error('Error:', err);
      }
    }
    
    async function showSubscriptionDetails(subId) {
      try {
        const response = await fetch(`/api/subscription/${subId}`);
        const data = await response.json();
        
        if (data.error) {
          alert(data.error);
          return;
        }
        
        document.getElementById('subscriptionDetailName').textContent = data.name + ' Details';
        
        let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em; margin-bottom: 1em;">
            <div style="background: var(--bg-hover); padding: 1em; border-radius: 8px;">
              <div style="font-weight: 600;">Type</div>
              <div>${data.utility_type.charAt(0).toUpperCase() + data.utility_type.slice(1)}</div>
            </div>
            <div style="background: var(--bg-hover); padding: 1em; border-radius: 8px;">
              <div style="font-weight: 600;">Category</div>
              <div>${data.category_type.charAt(0).toUpperCase() + data.category_type.slice(1)}</div>
            </div>
          </div>
          ${data.notes ? `<p style="margin-bottom: 1em; color: var(--text-secondary);"><em>${data.notes}</em></p>` : ''}
          <h5 style="margin: 1em 0 0.5em 0;">Recent Payments</h5>
          <div style="max-height: 200px; overflow-y: auto;">
        `;
        
        if (data.payments.length > 0) {
          data.payments.forEach(p => {
            const pdate = new Date(p.date);
            html += `
              <div style="display: flex; justify-content: space-between; padding: 0.4em 0; border-bottom: 1px solid var(--border-light);">
                <span>${pdate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                <span style="font-weight: 600;">$${p.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                <button onclick="deletePayment(${p.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.8em;">√ó</button>
              </div>
            `;
          });
        } else {
          html += '<p style="color: var(--text-secondary);">No payments recorded yet.</p>';
        }
        
        html += '</div>';
        
        // Add mini chart
        if (data.monthly_chart.labels.length > 0) {
          html += '<div style="margin-top: 1em;"><canvas id="subscriptionMiniChart" height="150"></canvas></div>';
        }
        
        document.getElementById('subscriptionDetailContent').innerHTML = html;
        document.getElementById('subscriptionDetailModal').classList.add('active');
        
        // Render mini chart if data exists
        if (data.monthly_chart.labels.length > 0) {
          const ctx = document.getElementById('subscriptionMiniChart');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.monthly_chart.labels,
              datasets: [{
                label: 'Monthly Total',
                data: data.monthly_chart.data,
                backgroundColor: 'rgba(56, 117, 232, 0.7)',
                borderRadius: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, ticks: { callback: v => '$' + v } }
              }
            }
          });
        }
      } catch (err) {
        console.error('Error loading subscription details:', err);
      }
    }
    
    function closeSubscriptionDetailModal() {
      document.getElementById('subscriptionDetailModal').classList.remove('active');
    }
    
    async function deletePayment(paymentId) {
      if (!confirm('Delete this payment?')) return;
      try {
        await fetch(`/budget/subscription/payment/${paymentId}`, { method: 'DELETE' });
        location.reload();
      } catch (err) {
        console.error('Error:', err);
      }
    }
    
    // ===== SUBSCRIPTION CHARTS =====
    const subscriptionData = {{ subscription_stats.subscriptions | tojson if subscription_stats else '[]' }};
    const chartColors = [
      '#3875e8', '#28a745', '#ffc107', '#dc3545', '#6f42c1',
      '#17a2b8', '#fd7e14', '#20c997', '#e83e8c', '#6c757d',
      '#5c6bc0', '#66bb6a', '#ffca28', '#ef5350', '#ab47bc'
    ];
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    // Initialize subscription breakdown chart (doughnut)
    const subBreakdownCtx = document.getElementById('subscriptionBreakdownChart');
    if (subBreakdownCtx && subscriptionData.length > 0) {
      const labels = subscriptionData.map(s => s.name);
      const data = subscriptionData.map(s => s.avg_3m);
      
      new Chart(subBreakdownCtx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: chartColors.slice(0, labels.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: isDark ? '#e4e6eb' : '#333', boxWidth: 12, font: { size: 10 } } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `$${context.parsed.toLocaleString()}/mo`;
                }
              }
            }
          }
        }
      });
    }
    
    // Initialize spending over time line chart
    let spendingTrendChart = null;
    let currentTimePeriod = '6M';  // Default time period
    const subTrendCtx = document.getElementById('subscriptionTrendChart');
    
    // Time period helper - get cutoff date
    function getTimePeriodCutoff(period) {
      const now = new Date();
      switch(period) {
        case '1W': return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        case '1M': return new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        case '3M': return new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
        case '6M': return new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
        case '1Y': return new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        case '2Y': return new Date(now.getFullYear() - 2, now.getMonth(), now.getDate());
        default: return new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
      }
    }
    
    // Set time period and rebuild chart
    function setTimePeriod(period) {
      currentTimePeriod = period;
      
      // Update button states
      document.querySelectorAll('.time-period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
      
      // Rebuild chart
      updateSpendingChart();
    }
    
    function buildSpendingTrendChart(filteredSubs) {
      if (!subTrendCtx) return;
      
      // Destroy existing chart
      if (spendingTrendChart) {
        spendingTrendChart.destroy();
      }
      
      if (!filteredSubs || filteredSubs.length === 0) {
        spendingTrendChart = new Chart(subTrendCtx, {
          type: 'line',
          data: { labels: ['No Data'], datasets: [] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'Select subscriptions to view trends', font: { size: 12 }, color: '#889ab0' }
            }
          }
        });
        return;
      }
      
      // Get time period cutoff
      const cutoffDate = getTimePeriodCutoff(currentTimePeriod);
      
      // Get all unique months from all subscriptions within time period
      const allMonths = new Set();
      filteredSubs.forEach(sub => {
        if (sub.payments && sub.payments.length > 0) {
          sub.payments.forEach(p => {
            const date = new Date(p.payment_date);
            if (date >= cutoffDate) {
              const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              allMonths.add(monthKey);
            }
          });
        }
      });
      
      // Sort months chronologically
      const sortedMonths = Array.from(allMonths).sort();
      
      // Create labels from months
      const labels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      });
      
      // Create datasets for each subscription
      const datasets = filteredSubs.map((sub, index) => {
        // Aggregate payments by month (filtered by time period)
        const monthlyData = {};
        if (sub.payments && sub.payments.length > 0) {
          sub.payments.forEach(p => {
            const date = new Date(p.payment_date);
            if (date >= cutoffDate) {
              const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              monthlyData[monthKey] = (monthlyData[monthKey] || 0) + p.amount;
            }
          });
        }
        
        // Create data array matching sorted months
        const data = sortedMonths.map(m => monthlyData[m] || null);
        
        return {
          label: sub.name,
          data: data,
          borderColor: chartColors[index % chartColors.length],
          backgroundColor: chartColors[index % chartColors.length] + '33',
          fill: false,
          tension: 0.3,
          pointRadius: 4,
          pointHoverRadius: 6,
          spanGaps: true
        };
      });
      
      spendingTrendChart = new Chart(subTrendCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { 
              position: 'bottom', 
              labels: { 
                color: isDark ? '#e4e6eb' : '#333',
                boxWidth: 12,
                font: { size: 11 },
                padding: 15
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.parsed.y === null) return null;
                  return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: isDark ? '#3d4450' : '#e8eef8' },
              ticks: { color: isDark ? '#98a3b8' : '#667a9a' }
            },
            y: {
              beginAtZero: true,
              grid: { color: isDark ? '#3d4450' : '#e8eef8' },
              ticks: { 
                color: isDark ? '#98a3b8' : '#667a9a',
                callback: v => '$' + v.toLocaleString()
              }
            }
          }
        }
      });
    }
    
    // Filter dropdown toggle
    function toggleSubscriptionFilter() {
      const dropdown = document.getElementById('subscriptionFilterDropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const container = document.querySelector('.subscription-filter-container');
      const dropdown = document.getElementById('subscriptionFilterDropdown');
      if (container && dropdown && !container.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
    
    // Toggle all subscriptions
    function toggleAllSubscriptions(checked) {
      document.querySelectorAll('.subscription-filter-cb').forEach(cb => {
        cb.checked = checked;
      });
      updateSpendingChart();
    }
    
    // Update chart based on selected subscriptions
    function updateSpendingChart() {
      const checkboxes = document.querySelectorAll('.subscription-filter-cb:checked');
      const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.subId));
      
      // Update select all checkbox state
      const allCheckboxes = document.querySelectorAll('.subscription-filter-cb');
      const selectAll = document.getElementById('subscriptionSelectAll');
      if (selectAll) {
        selectAll.checked = checkboxes.length === allCheckboxes.length;
        selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
      }
      
      // Filter subscription data and rebuild chart
      const filteredSubs = subscriptionData.filter(s => selectedIds.includes(s.id));
      buildSpendingTrendChart(filteredSubs);
    }
    
    // Initialize chart with all subscriptions
    if (subscriptionData.length > 0) {
      buildSpendingTrendChart(subscriptionData);
    }
  </script>
</body>
</html>
